{"remainingRequest":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/jlglqa/Documents/QA/noa/src/pages/testTools/prMergedNotify.vue?vue&type=style&index=0&id=1465bd21&lang=scss&scoped=true&","dependencies":[{"path":"/Users/jlglqa/Documents/QA/noa/src/pages/testTools/prMergedNotify.vue","mtime":1655949681779},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/css-loader/dist/cjs.js","mtime":1644298105513},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":1644314988580},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/@vue/cli-service/node_modules/postcss-loader/src/index.js","mtime":1644298105780},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/sass-loader/dist/cjs.js","mtime":1644314983366},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/cache-loader/dist/cjs.js","mtime":1644298102062},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/index.js","mtime":1644314988580}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgpAaW1wb3J0ICJzcmMvYXNzZXRzL2Nzcy91dGlscyI7CgouY2FyZC1jb250ZW50IHsKICBvdmVyZmxvdy15OiBhdXRvOwp9CgouZGlhbG9nLXRpdGxlIHsKICBAZXh0ZW5kICVkaWFsb2ctdGl0bGU7Cn0K"},{"version":3,"sources":["prMergedNotify.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuTA;;AAEA;AACA;AACA;;AAEA;AACA;AACA","file":"prMergedNotify.vue","sourceRoot":"src/pages/testTools","sourcesContent":["<template>\n  <div>\n    <el-card class=\"card-content\">\n      <template slot=\"header\">\n        <table-header\n          :condition=\"condition\"\n          create-tip=\"创建PR合并通知群配置\"\n          placeholder=\"根据项目名称搜索\"\n          @create=\"handleAddOrEdit\"\n          @search=\"handleSearch\"\n        >\n          <template slot=\"title\">\n            <div>PR合并通知配置</div>\n          </template>\n        </table-header>\n      </template>\n      <el-table ref=\"table\" v-loading=\"loading\" :data=\"tableData\" @filter-change=\"filter\">\n\n        <!--  项目名称  -->\n        <el-table-column label=\"项目名称\" prop=\"project\" show-overflow-tooltip/>\n\n        <!--  源分支  -->\n        <el-table-column label=\"源分支\" prop=\"sourceBranch\"/>\n\n        <!--  目标分支  -->\n        <el-table-column label=\"目标分支\" prop=\"targetBranch\"/>\n\n        <!--  群聊  -->\n        <el-table-column :filters=\"larkChatOptions\" column-key=\"chatId\" label=\"群聊\" prop=\"chatName\"/>\n\n        <!--  操作  -->\n        <el-table-column :width=\"table2BtnWidth\" label=\"操作\">\n          <template slot-scope=\"scope\">\n            <table-operator\n              show-delete\n              show-edit\n              @deleteClick=\"handleDelete(scope.row)\"\n              @editClick=\"handleAddOrEdit(scope.row)\"\n            />\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <table-pagination\n        :change=\"initTableData\"\n        :current-page.sync=\"currentPage\"\n        :page-size.sync=\"pageSize\"\n        :total=\"total\"\n      />\n    </el-card>\n\n    <el-dialog\n      :close-on-click-modal=\"false\"\n      :title=\"operation === operationEnum.EDIT? '编辑PR合并群聊配置' : '创建PR合并群聊配置'\"\n      :visible.sync=\"dialogFormVisible\"\n      class=\"dialog-title\"\n      width=\"65%\"\n    >\n\n      <el-form ref=\"prMergedNotifyForm\" :model=\"form\" :rules=\"rules\">\n\n        <el-row>\n          <el-col :offset=\"1\" :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"项目\" prop=\"project\">\n              <el-select v-model=\"form.project\" filterable placeholder=\"请选择项目\">\n                <el-option\n                  v-for=\"item in projectPathOptions\"\n                  :key=\"item.path\"\n                  :label=\"item.project\"\n                  :value=\"item.path\"\n                />\n              </el-select>\n            </el-form-item>\n          </el-col>\n\n          <el-col :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"源分支\" prop=\"sourceBranch\">\n              <el-input v-model=\"form.sourceBranch\" placeholder=\"请输入源分支名称\"/>\n            </el-form-item>\n          </el-col>\n        </el-row>\n\n        <el-row>\n          <el-col :offset=\"1\" :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"目标分支\" prop=\"targetBranch\">\n              <el-input v-model=\"form.targetBranch\" placeholder=\"请输入目标分支名称\"/>\n            </el-form-item>\n          </el-col>\n\n          <el-col :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"推送群聊\" prop=\"chatId\">\n              <el-select\n                v-model=\"form.chatId\"\n                filterable\n                placeholder=\"请选择需要通知的群\"\n                style=\"width: 100%;\"\n              >\n                <el-option\n                  v-for=\"item in larkChatOptions\"\n                  :key=\"item.value\"\n                  :label=\"item.text\"\n                  :value=\"item.value\"\n                />\n              </el-select>\n            </el-form-item>\n          </el-col>\n        </el-row>\n\n      </el-form>\n\n      <template slot=\"footer\">\n        <dialog-footer @cancel=\"dialogFormVisible = false\" @confirm=\"saveConfig\"/>\n      </template>\n    </el-dialog>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {gitlabChatApi} from \"@/api\"\nimport {\n  RequestCreateGitlabChatConfig,\n  RequestGetGitlabChatConfigList,\n  RequestUpdateGitlabChatConfig\n} from \"@/api/types/gitlab\"\nimport {typeGitlabChatData} from \"@/api/types/gitlabType\"\nimport variables from \"@/assets/css/utils.scss\"\nimport DialogFooter from '@/common/components/DialogFooter.vue'\nimport TablePagination from \"@/common/components/pagination/TablePagination.vue\"\nimport TableHeader from \"@/common/components/TableHeader.vue\"\nimport TableOperator from \"@/common/components/TableOperator.vue\"\nimport {_filter} from \"@/common/utils\"\nimport {PAGINATION_SIZE} from \"@/constant\"\nimport {operationEnum} from \"@/constant/Gitlab\"\nimport {planStageEnum} from \"@/constant/TestPlan\"\nimport {prMergedNotifyForm, prMergedNotifyRules} from \"@/pages/testTools/form\"\nimport {cloneDeep} from \"lodash\"\n\nexport default {\n  name: \"prMergedNotify\",\n  data() {\n    return {\n      operationEnum: operationEnum,\n      planStageEnum: planStageEnum,\n      larkChatOptions: [],\n      tableData: [],\n      currentPage: 1,\n      pageSize: PAGINATION_SIZE.LARGE,\n      total: 0,\n      form: prMergedNotifyForm,\n      rules: prMergedNotifyRules,\n      dialogFormVisible: false,\n      operation: '',\n      projectPathOptions: [],\n      condition: {},\n    }\n  },\n  components: {\n    TableOperator,\n    TableHeader,\n    TablePagination,\n    DialogFooter,\n  },\n  computed: {\n    formLabelWidth() {\n      return '80px'\n    },\n    chatOptions() {\n      return this.$store.state.coverage.larkChats\n    },\n    loading() {\n      return this.$store.state.loading\n    },\n    table2BtnWidth() {\n      return variables['table2BtnWidth']\n    }\n  },\n  mounted() {\n    this.initTableData()\n  },\n  methods: {\n    initOptions() {\n      this.setProjectPathOptions()\n      this.setLarkChatOptions()\n    },\n    initTableData() {\n      this.initOptions()\n      this.getData()\n    },\n    saveConfig() {\n      this.$refs.prMergedNotifyForm.validate((valid: boolean) => {\n        if (valid) {\n          if (this.operation === operationEnum.ADD) {\n            const body: RequestCreateGitlabChatConfig = this.buildParams()\n            gitlabChatApi.createGitlabChatConfig(body)\n              .then(() => {\n                this.refresh()\n              })\n          } else if (this.operation === operationEnum.EDIT) {\n            const body: RequestUpdateGitlabChatConfig = this.buildParams()\n            gitlabChatApi.updateGitlabChatConfig(this.form.id, body)\n              .then(() => {\n                this.refresh()\n              })\n          }\n          this.dialogFormVisible = false\n        } else {\n          return false\n        }\n      })\n    },\n    buildParams() {\n      let body: RequestCreateGitlabChatConfig | RequestUpdateGitlabChatConfig = {\n        project: this.form.project,\n        sourceBranch: this.form.sourceBranch,\n        targetBranch: this.form.targetBranch,\n        chatId: this.form.chatId,\n      }\n      return body\n    },\n    setProjectPathOptions() {\n      gitlabChatApi.getAllGitlabProjects()\n        .then(({data}) => {\n          this.projectPathOptions = data.data\n        })\n    },\n    getData(value?: string) {\n      const params: RequestGetGitlabChatConfigList = {\n        offset: this.pageSize * (this.currentPage - 1),\n        limit: this.pageSize,\n        project: value\n      }\n\n      this.configFilter = sessionStorage.getItem(this.$route.path)\n      this.configFilter = this.configFilter ? JSON.parse(this.configFilter) : {}\n      if (JSON.stringify(this.configFilter) !== \"{}\") {\n        Object.assign(params, this.configFilter)\n        this.$refs.table.columns.forEach((item: any) => {\n          item.filteredValue = this.configFilter[item.columnKey]\n        })\n      }\n\n      gitlabChatApi.getGitlabChatConfigList(params)\n        .then(({data}) => {\n          this.total = data.total\n          this.tableData = data.data\n          this.tableData.forEach((item: typeGitlabChatData) => {\n            let chat = this.chatOptions.find((s: {id: number}) => String(s.id) === item.chatId)\n            item.chatName = chat.name\n            item.chatLarkId = chat.chatId\n          })\n        })\n    },\n    handleAddOrEdit(gitlabChatConfig?: typeGitlabChatData) {\n      console.log(gitlabChatConfig)\n      this.dialogFormVisible = true\n      this.$nextTick(() => {\n        if (this.$refs.prMergedNotifyForm) {\n          this.$refs.prMergedNotifyForm.resetFields()\n        }\n        this.operation = operationEnum.ADD\n        //修改\n        if (gitlabChatConfig) {\n          this.operation = operationEnum.EDIT\n          this.form = cloneDeep(gitlabChatConfig)\n        } else {\n          this.form = prMergedNotifyForm\n        }\n        this.initOptions()\n      })\n    },\n    handleDelete(gitlabChatConfig: typeGitlabChatData) {\n      this.$alert('确认删除该配置?', '', {\n        confirmButtonText: '确定',\n        showCancelButton: true,\n        cancelButtonText: '取消',\n        callback: (action: string) => {\n          if (action === 'confirm') {\n            gitlabChatApi.deleteGitlabChatConfig(gitlabChatConfig.id)\n              .then(() => {\n                this.refresh()\n              })\n          }\n        }\n      })\n    },\n    handleSearch(value?: string) {\n      this.currentPage = 1\n      this.getData(value)\n    },\n    refresh() {\n      this.initTableData()\n    },\n    filter(filters: any) {\n      this.currentPage = 1\n      _filter(filters, this.configFilter, this.$route.path)\n      this.initTableData()\n    },\n    setLarkChatOptions() {\n      // 群聊筛选\n      this.larkChatOptions = Object.entries(this.chatOptions).map(([key, value]) => {\n        // @ts-ignore\n        return {text: value.name, value: String(value.id), key: key}\n      })\n      console.log(this.larkChatOptions, this.chatOptions)\n    }\n  }\n}\n\n</script>\n\n<style lang=\"scss\" scoped>\n@import \"src/assets/css/utils\";\n\n.card-content {\n  overflow-y: auto;\n}\n\n.dialog-title {\n  @extend %dialog-title;\n}\n</style>\n"]}]}