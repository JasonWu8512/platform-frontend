{"remainingRequest":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/jlglqa/Documents/QA/noa/src/pages/testTools/approvalNotify.vue?vue&type=style&index=0&id=320e8156&lang=scss&scoped=true&","dependencies":[{"path":"/Users/jlglqa/Documents/QA/noa/src/pages/testTools/approvalNotify.vue","mtime":1655949681778},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/css-loader/dist/cjs.js","mtime":1644298105513},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":1644314988580},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/@vue/cli-service/node_modules/postcss-loader/src/index.js","mtime":1644298105780},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/sass-loader/dist/cjs.js","mtime":1644314983366},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/cache-loader/dist/cjs.js","mtime":1644298102062},{"path":"/Users/jlglqa/Documents/QA/noa/node_modules/vue-loader/lib/index.js","mtime":1644314988580}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKQGltcG9ydCAic3JjL2Fzc2V0cy9jc3MvdXRpbHMiOwoKLmNhcmQtY29udGVudCB7CiAgb3ZlcmZsb3cteTogYXV0bzsKfQoKLmRpYWxvZy10aXRsZSB7CiAgQGV4dGVuZCAlZGlhbG9nLXRpdGxlOwp9Cg=="},{"version":3,"sources":["approvalNotify.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuRA;;AAEA;AACA;AACA;;AAEA;AACA;AACA","file":"approvalNotify.vue","sourceRoot":"src/pages/testTools","sourcesContent":["<template>\n  <div>\n    <el-card class=\"card-content\">\n      <template slot=\"header\">\n        <table-header\n          :condition=\"condition\"\n          create-tip=\"审批流通知配置\"\n          placeholder=\"根据项目名称搜索\"\n          @create=\"handleAddOrEdit\"\n          @search=\"handleSearch\"\n        >\n          <template slot=\"title\">\n            <div>审批流通知配置</div>\n          </template>\n        </table-header>\n      </template>\n      <el-table ref=\"table\" v-loading=\"loading\" :data=\"tableData\" @filter-change=\"filter\">\n\n        <!--  项目名称  -->\n        <el-table-column label=\"项目名称\" prop=\"project\" show-overflow-tooltip/>\n\n        <!--  群聊  -->\n        <el-table-column :filters=\"larkChatOptions\" column-key=\"chatId\" label=\"群聊\" prop=\"chatName\"/>\n\n        <!--  操作  -->\n        <el-table-column :width=\"table2BtnWidth\" label=\"操作\">\n          <template slot-scope=\"scope\">\n            <table-operator\n              show-delete\n              show-edit\n              @deleteClick=\"handleDelete(scope.row)\"\n              @editClick=\"handleAddOrEdit(scope.row)\"\n            />\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <table-pagination\n        :change=\"initTableData\"\n        :current-page.sync=\"currentPage\"\n        :page-size.sync=\"pageSize\"\n        :total=\"total\"\n      />\n    </el-card>\n\n    <el-dialog\n      :close-on-click-modal=\"false\"\n      :title=\"operation === operationEnum.EDIT? '编辑审批流通知配置' : '创建审批流通知配置'\"\n      :visible.sync=\"dialogFormVisible\"\n      class=\"dialog-title\"\n      width=\"65%\"\n    >\n\n      <el-form ref=\"approvalNotifyForm\" :model=\"form\" :rules=\"rules\">\n        <el-row>\n          <el-col :offset=\"1\" :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"项目\" prop=\"project\">\n              <el-select v-model=\"form.project\" filterable placeholder=\"请选择项目\">\n                <el-option\n                  v-for=\"item in jiraProjectOptions\"\n                  :key=\"item.id\"\n                  :label=\"item.name\"\n                  :value=\"item.id\"\n                />\n              </el-select>\n            </el-form-item>\n          </el-col>\n\n          <el-col :span=\"10\">\n            <el-form-item :label-width=\"formLabelWidth\" label=\"推送群聊\" prop=\"chatId\">\n              <el-select\n                v-model=\"form.chatId\"\n                filterable\n                placeholder=\"请选择需要通知的群\"\n                style=\"width: 100%;\"\n              >\n                <el-option\n                  v-for=\"item in larkChatOptions\"\n                  :key=\"item.value\"\n                  :label=\"item.text\"\n                  :value=\"item.value\"\n                />\n              </el-select>\n            </el-form-item>\n          </el-col>\n        </el-row>\n      </el-form>\n\n      <template slot=\"footer\">\n        <dialog-footer @cancel=\"dialogFormVisible = false\" @confirm=\"saveConfig\"/>\n      </template>\n    </el-dialog>\n  </div>\n\n</template>\n\n<script lang=\"ts\">\nimport {approvalApi} from \"@/api\"\nimport {\n  RequestCreateApprovalChatConfig,\n  RequestGetApprovalChatConfigList,\n  RequestUpdateApprovalChatConfig,\n  typeApprovalChatData\n} from \"@/api/types/approval\"\nimport variables from \"@/assets/css/utils.scss\"\nimport DialogFooter from '@/common/components/DialogFooter.vue'\nimport TablePagination from \"@/common/components/pagination/TablePagination.vue\"\nimport TableHeader from \"@/common/components/TableHeader.vue\"\nimport TableOperator from \"@/common/components/TableOperator.vue\"\nimport {_filter} from \"@/common/utils\"\nimport {PAGINATION_SIZE} from \"@/constant\"\nimport {operationEnum} from \"@/constant/Gitlab\"\nimport {planStageEnum} from \"@/constant/TestPlan\"\nimport {approvalNotifyForm, approvalNotifyRules} from \"@/pages/testTools/form\"\nimport {cloneDeep} from \"lodash\"\n\nexport default {\n  name: \"approvalNotify\",\n  components: {\n    TableOperator,\n    TableHeader,\n    TablePagination,\n    DialogFooter,\n  },\n  data() {\n    return {\n      condition: {},\n      operationEnum: operationEnum,\n      planStageEnum: planStageEnum,\n      tableData: [],\n      currentPage: 1,\n      pageSize: PAGINATION_SIZE.LARGE,\n      total: 0,\n      form: approvalNotifyForm,\n      rules: approvalNotifyRules,\n      dialogFormVisible: false,\n      larkChatOptions: [],\n      operation: '',\n    }\n  },\n  computed: {\n    formLabelWidth() {\n      return variables['formLabelWidth']\n    },\n    loading() {\n      return this.$store.state.loading\n    },\n    jiraProjectOptions() {\n      return this.$store.state.jira.projects\n    },\n    chatOptions() {\n      return this.$store.state.coverage.larkChats\n    },\n    table2BtnWidth() {\n      return variables['table2BtnWidth']\n    }\n  },\n  mounted() {\n    this.initTableData()\n  },\n  methods: {\n    initOptions() {\n      this.setLarkChatOptions()\n    },\n    initTableData() {\n      this.initOptions()\n      this.getData()\n    },\n    buildParams() {\n      let body: RequestCreateApprovalChatConfig | RequestUpdateApprovalChatConfig = {\n        project: this.form.project,\n        chatId: this.form.chatId,\n      }\n      return body\n    },\n    getData(value?: string) {\n      const params: RequestGetApprovalChatConfigList = {\n        offset: this.pageSize * (this.currentPage - 1),\n        limit: this.pageSize,\n        project: value\n      }\n\n      this.configFilter = sessionStorage.getItem(this.$route.path)\n      this.configFilter = this.configFilter ? JSON.parse(this.configFilter) : {}\n      if (JSON.stringify(this.configFilter) !== \"{}\") {\n        Object.assign(params, this.configFilter)\n        this.$refs.table.columns.forEach((item: any) => {\n          item.filteredValue = this.configFilter[item.columnKey]\n        })\n      }\n\n      approvalApi.getApprovalChatConfig(params)\n        .then(({data}) => {\n          this.total = data.total\n          this.tableData = data.data\n          this.tableData.forEach((item: typeApprovalChatData) => {\n            item.chatName = this.chatOptions.find((s: { id: number }) => String(s.id) === item.chatId).name\n            item.project = this.jiraProjectOptions.find((s: { id: string }) => s.id === item.project).name\n          })\n        })\n    },\n    saveConfig() {\n      this.$refs.approvalNotifyForm.validate((valid: boolean) => {\n        if (valid) {\n          if (this.operation === operationEnum.ADD) {\n            const body: RequestCreateApprovalChatConfig = this.buildParams()\n            approvalApi.createApprovalChatConfig(body)\n              .then(() => {\n                this.refresh()\n              })\n          } else if (this.operation === operationEnum.EDIT) {\n            const body: RequestUpdateApprovalChatConfig = this.buildParams()\n            approvalApi.updateApprovalChatConfig(this.form.id, body)\n              .then(() => {\n                this.refresh()\n              })\n          }\n          this.dialogFormVisible = false\n        } else {\n          return false\n        }\n      })\n    },\n    handleAddOrEdit(approvalChatConfig?: typeApprovalChatData) {\n      this.dialogFormVisible = true\n      this.$nextTick(() => {\n        if (this.$refs.approvalNotifyForm) {\n          this.$refs.approvalNotifyForm.resetFields()\n        }\n        this.operation = operationEnum.ADD\n        //修改\n        if (approvalChatConfig) {\n          this.operation = operationEnum.EDIT\n          this.form = cloneDeep(approvalChatConfig)\n          this.form.isActive = String(this.form.isJiraActive)\n        } else {\n          this.form = approvalNotifyForm\n        }\n      })\n    },\n    handleDelete(approvalChatConfig: typeApprovalChatData) {\n      this.$alert('确认删除该配置?', '', {\n        confirmButtonText: '确定',\n        showCancelButton: true,\n        cancelButtonText: '取消',\n        callback: (action: string) => {\n          if (action === 'confirm') {\n            approvalApi.deleteApprovalChatConfig(approvalChatConfig.id)\n              .then(() => {\n                this.refresh()\n              })\n          }\n        }\n      })\n    },\n    handleSearch(value?: string) {\n      this.currentPage = 1\n      this.getData(value)\n    },\n    refresh() {\n      this.initTableData()\n    },\n    filter(filters: any) {\n      this.currentPage = 1\n      _filter(filters, this.configFilter, this.$route.path)\n      this.initTableData()\n    },\n    setLarkChatOptions() {\n      // 群聊筛选\n      this.larkChatOptions = Object.entries(this.chatOptions).map(([key, value]) => {\n        // @ts-ignore\n        return {text: value.name, value: String(value.id), key: key}\n      })\n    }\n  },\n}\n</script>\n\n<style lang=\"scss\" scoped>\n@import \"src/assets/css/utils\";\n\n.card-content {\n  overflow-y: auto;\n}\n\n.dialog-title {\n  @extend %dialog-title;\n}\n</style>\n"]}]}